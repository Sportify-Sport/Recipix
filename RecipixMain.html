<!--<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipix</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="RecipixMain.css" rel="stylesheet" />
</head>
<body>
    <header>
        <div class="logo">Recipix</div>
        <nav>
            <a href="RecipixMain.html">Home</a>
            <a href="ProfileAdmin.html">Profile</a>
        </nav>
        <div class="profile">
            <a href="login.html">Login</a>
        </div>
    </header>

    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search for recipes...">
        <select id="sort-select">
            <option value="Newest">Sort by Newest</option>
            <option value="Rating">Sort by Rating</option>
        </select>
    </div>

    <div class="recipes-container" id="recipes-container">-->
<!-- Recipe cards will be dynamically injected here -->
<!--</div>

    <footer>
        &copy; 2025 Recipix. All rights reserved.
    </footer>

    <script>
        const recipesContainer = document.getElementById('recipes-container');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');
        let user = null; // Stores the current user data
        let allRecipes = []; // Stores all fetched recipes

        // Fetch the current user profile
        const fetchUser = async () => {
            const response = await fetch('https://ty6ieut9fc.execute-api.us-east-1.amazonaws.com/prod/getUserProfile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ body: JSON.stringify({ UserId: 'user-5678' }) }),
            });

            const data = await response.json();
            // Parse the body string into an object
            user = JSON.parse(data.body);
            console.log(user);
        };

        // Render recipes
        const renderRecipes = (recipes) => {
            recipesContainer.innerHTML = ''; // Clear the container
            recipes.forEach(recipe => {
                const isSaved = user.SavedRecipes?.includes(recipe.RecipeId);
                const recipeCard = document.createElement('div');
                recipeCard.classList.add('recipe-card');

                // Add user info
                recipeCard.innerHTML += `
                    <div class="user-info">
                        <span class="username">${recipe.CreatorUsername}</span>
                        <span class="create-date">${new Date(recipe.CreatedAt).toLocaleDateString()}</span>
                    </div>
                    <h3 class="title">${recipe.Title}</h3>
                    <p class="description">${recipe.Description}</p>
                    <p class="category">Category: ${recipe.Category}</p>
                    <img src="${recipe.ImageURL || 'default-image.jpg'}" alt="${recipe.Title}">
                    <p class="rating">Rating: ${recipe.Rating}</p>
                `;

                // Add ingredients and steps
                const ingredientsText = document.createElement('p');
                ingredientsText.classList.add('expand-text');
                ingredientsText.textContent = 'Ingredients';
                ingredientsText.addEventListener('click', () => {
                    ingredientsList.style.display = ingredientsList.style.display === 'none' ? 'block' : 'none';
                });

                const ingredientsList = document.createElement('div');
                ingredientsList.classList.add('ingredients');
                ingredientsList.innerHTML = `<ul>${recipe.Ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>`;
                ingredientsList.style.display = 'none';

                const stepsText = document.createElement('p');
                stepsText.classList.add('expand-text');
                stepsText.textContent = 'Steps';
                stepsText.addEventListener('click', () => {
                    stepsList.style.display = stepsList.style.display === 'none' ? 'block' : 'none';
                });

                const stepsList = document.createElement('div');
                stepsList.classList.add('steps');
                stepsList.innerHTML = `<ol>${recipe.Steps.map(step => `<li>${step}</li>`).join('')}</ol>`;
                stepsList.style.display = 'none';

                recipeCard.appendChild(ingredientsText);
                recipeCard.appendChild(ingredientsList);
                recipeCard.appendChild(stepsText);
                recipeCard.appendChild(stepsList);

                // Add Save/Unsave button
                const saveButton = document.createElement('button');
                saveButton.textContent = isSaved ? 'Unsave' : 'Save';
                saveButton.addEventListener('click', () => handleSave(recipe.RecipeId, saveButton));
                recipeCard.appendChild(saveButton);

                recipesContainer.appendChild(recipeCard);
            });
        };

        // Fetch all recipes
        const fetchRecipes = async () => {
            const response = await fetch('https://ty6ieut9fc.execute-api.us-east-1.amazonaws.com/prod/getAllRecipes');
            const data = await response.json();
            allRecipes = JSON.parse(data.body).recipes;
            handleSort(allRecipes, 'Newest');
        };

        // Save or Unsave a recipe
        const handleSave = async (recipeId, button) => {
            const isSaved = user.SavedRecipes?.includes(recipeId);
            const apiUrl = isSaved
                ? 'https://ty6ieut9fc.execute-api.us-east-1.amazonaws.com/prod/UnsaveRecipe'
                : 'https://ty6ieut9fc.execute-api.us-east-1.amazonaws.com/prod/saveRecipe';

            const method = isSaved ? 'PUT' : 'POST';

            const response = await fetch(apiUrl, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    body: JSON.stringify({ UserId: user.UserId, RecipeId: recipeId }),
                }),
            });

            if (response.ok) {
                if (isSaved) {
                    user.SavedRecipes = user.SavedRecipes.filter(id => id !== recipeId);
                    button.textContent = 'Save';
                    alert('Recipe removed from saved list!');
                } else {
                    user.SavedRecipes = [...(user.SavedRecipes || []), recipeId];
                    button.textContent = 'Unsave';
                    alert('Recipe added to saved list!');
                }
            } else {
                console.error('Error saving/unsaving the recipe');
                alert('An error occurred. Please try again.');
            }
        };

        // Handle sorting
        const handleSort = (recipes, sortBy) => {
            let sortedRecipes = [...recipes];
            if (sortBy === 'Newest') {
                sortedRecipes.sort((a, b) => new Date(b.CreatedAt) - new Date(a.CreatedAt));
            } else if (sortBy === 'Rating') {
                sortedRecipes.sort((a, b) => b.Rating - a.Rating);
            }
            renderRecipes(sortedRecipes);
        };

        // Handle search
        const handleSearch = async () => {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                handleSort(allRecipes, sortSelect.value);
                return;
            }

            const response = await fetch('https://ty6ieut9fc.execute-api.us-east-1.amazonaws.com/prod/searchRecipes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ body: JSON.stringify({ Keyword: keyword }) }),
            });
            const data = await response.json();
            const searchResults = JSON.parse(data.body).recipes;
            renderRecipes(searchResults);
        };

        // Initialize page
        const init = async () => {
            await fetchUser();
            await fetchRecipes();
            sortSelect.addEventListener('change', () => handleSort(allRecipes, sortSelect.value));
            searchInput.addEventListener('input', handleSearch);
        };

        init();
    </script>

</body>
</html>-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipix</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="RecipixMain.css" rel="stylesheet" />
</head>
<body>
    <header>
        <div class="logo">Recipix</div>
        <nav>
            <a href="RecipixMain.html">Home</a>
            <a href="ProfileAdmin.html">Profile</a>
        </nav>
        <div class="profile">
            <a href="login.html">Login</a>
        </div>
    </header>

    <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search for recipes...">
        <select id="sort-select">
            <option value="Newest">Sort by Newest</option>
            <option value="Rating">Sort by Rating</option>
        </select>
    </div>

    <div class="recipes-container" id="recipes-container">
        <!-- Recipe cards will be dynamically injected here -->
    </div>

    <footer>
        &copy; 2025 Recipix. All rights reserved.
    </footer>

    <!-- Review Modal -->
    <div id="review-modal" style="display:none;">
        <form id="review-form">
            <textarea id="review-description" placeholder="Write your review..."></textarea>
            <input type="number" id="review-rating" placeholder="Rating (1-5)" min="1" max="5" />
            <input type="text" id="review-image" placeholder="Image URL (optional)" />
            <button type="submit">Submit Review</button>
        </form>
        <button onclick="closeReviewModal()">Close</button>
    </div>

    <script>
        const recipesContainer = document.getElementById('recipes-container');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');
        const reviewModal = document.getElementById('review-modal');
        const reviewForm = document.getElementById('review-form');
        const reviewDescriptionInput = document.getElementById('review-description');
        const reviewRatingInput = document.getElementById('review-rating');
        const reviewImageInput = document.getElementById('review-image');
        let user = null; // Stores the current user data
        let allRecipes = []; // Stores all fetched recipes

        // Fetch the current user profile
        const fetchUser = async () => {
            const response = await fetch('https://0oo843p1e5.execute-api.us-east-1.amazonaws.com/prod/getUserProfile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ body: JSON.stringify({ UserId: 'user-5678' }) }),
            });

            const data = await response.json();
            // Parse the body string into an object
            user = JSON.parse(data.body);
            console.log(user);
        };

        // Render recipes
        const renderRecipes = (recipes) => {
            recipesContainer.innerHTML = ''; // Clear the container
            recipes.forEach(recipe => {
                const isSaved = user.SavedRecipes?.includes(recipe.RecipeId);
                const recipeCard = document.createElement('div');
                recipeCard.classList.add('recipe-card');

                // Add user info
                recipeCard.innerHTML += `
                        <div class="user-info">
                            <span class="username">${recipe.CreatorUsername}</span>
                            <span class="create-date">${new Date(recipe.CreatedAt).toLocaleDateString()}</span>
                        </div>
                        <h3 class="title">${recipe.Title}</h3>
                        <p class="description">${recipe.Description}</p>
                        <p class="category">Category: ${recipe.Category}</p>
                        <img src="${recipe.ImageURL || 'default-image.jpg'}" alt="${recipe.Title}">
                        <p class="rating">Rating: ${recipe.Rating}</p>
                    `;

                // Add ingredients and steps
                const ingredientsText = document.createElement('p');
                ingredientsText.classList.add('expand-text');
                ingredientsText.textContent = 'Ingredients';
                ingredientsText.addEventListener('click', () => {
                    ingredientsList.style.display = ingredientsList.style.display === 'none' ? 'block' : 'none';
                });

                const ingredientsList = document.createElement('div');
                ingredientsList.classList.add('ingredients');
                ingredientsList.innerHTML = `<ul>${recipe.Ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>`;
                ingredientsList.style.display = 'none';

                const stepsText = document.createElement('p');
                stepsText.classList.add('expand-text');
                stepsText.textContent = 'Steps';
                stepsText.addEventListener('click', () => {
                    stepsList.style.display = stepsList.style.display === 'none' ? 'block' : 'none';
                });

                const stepsList = document.createElement('div');
                stepsList.classList.add('steps');
                stepsList.innerHTML = `<ol>${recipe.Steps.map(step => `<li>${step}</li>`).join('')}</ol>`;
                stepsList.style.display = 'none';

                recipeCard.appendChild(ingredientsText);
                recipeCard.appendChild(ingredientsList);
                recipeCard.appendChild(stepsText);
                recipeCard.appendChild(stepsList);

                // Add Save/Unsave button
                const saveButton = document.createElement('button');
                saveButton.textContent = isSaved ? 'Unsave' : 'Save';
                saveButton.addEventListener('click', () => handleSave(recipe.RecipeId, saveButton));
                recipeCard.appendChild(saveButton);

                // Reviews Button
                const reviewsButton = document.createElement('button');
                reviewsButton.textContent = 'Reviews';
                reviewsButton.addEventListener('click', () => handleReviews(recipe.RecipeId, recipeCard));
                recipeCard.appendChild(reviewsButton);

                recipesContainer.appendChild(recipeCard);
            });
        };

        // Fetch all recipes
        const fetchRecipes = async () => {
            const response = await fetch('https://0oo843p1e5.execute-api.us-east-1.amazonaws.com/prod/fetchRecipes');
            const data = await response.json();
            allRecipes = JSON.parse(data.body).recipes;
            handleSort(allRecipes, 'Newest');
        };

        // Save or Unsave a recipe
        const handleSave = async (recipeId, button) => {
            const isSaved = user.SavedRecipes?.includes(recipeId);
            const apiUrl = isSaved
                ? 'https://0oo843p1e5.execute-api.us-east-1.amazonaws.com/prod/unSaveRecipe'
                : 'https://0oo843p1e5.execute-api.us-east-1.amazonaws.com/prod/saveRecipe';

            const method = isSaved ? 'PUT' : 'POST';

            const response = await fetch(apiUrl, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    body: JSON.stringify({ UserId: user.UserId, RecipeId: recipeId }),
                }),
            });

            if (response.ok) {
                if (isSaved) {
                    user.SavedRecipes = user.SavedRecipes.filter(id => id !== recipeId);
                    button.textContent = 'Save';
                    alert('Recipe removed from saved list!');
                } else {
                    user.SavedRecipes = [...(user.SavedRecipes || []), recipeId];
                    button.textContent = 'Unsave';
                    alert('Recipe added to saved list!');
                }
            } else {
                console.error('Error saving/unsaving the recipe');
                alert('An error occurred. Please try again.');
            }
        };

        // Handle sorting
        const handleSort = (recipes, sortBy) => {
            let sortedRecipes = [...recipes];
            if (sortBy === 'Newest') {
                sortedRecipes.sort((a, b) => new Date(b.CreatedAt) - new Date(a.CreatedAt));
            } else if (sortBy === 'Rating') {
                sortedRecipes.sort((a, b) => b.Rating - a.Rating);
            }
            renderRecipes(sortedRecipes);
        };

        // Handle search
        const handleSearch = async () => {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                handleSort(allRecipes, sortSelect.value);
                return;
            }

            const response = await fetch('https://0oo843p1e5.execute-api.us-east-1.amazonaws.com/prod/searchRecipes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ body: JSON.stringify({ Keyword: keyword }) }),
            });
            const data = await response.json();
            const searchResults = JSON.parse(data.body).recipes;
            renderRecipes(searchResults);
        };

        // Handle reviews
        const handleReviews = async (recipeId, recipeCard) => {
            const reviewsDiv = document.createElement('div');
            reviewsDiv.classList.add('reviews-list');

            const response = await fetch('https://0oo843p1e5.execute-api.us-east-1.amazonaws.com/prod/getReviews', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    body: JSON.stringify({ RecipeId: recipeId }),
                }),
            });

            const data = await response.json();

            // Ensure that 'body' contains a stringified JSON object
            if (data.body) {
                const reviews = JSON.parse(data.body).Reviews;
                console.log(reviews);  // Now you have the list of reviews with Usernames
            } else {
                console.log("No reviews found or an error occurred.");
            }
            // Display reviews
            reviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.classList.add('review-card');
                reviewCard.innerHTML = `
                        <div class="user-info">
                            <span class="username">${review.Username}</span>
                            <span class="create-date">${new Date(review.CreatedAt).toLocaleDateString()}</span>
                        </div>
                        <p class="description">${review.Description}</p>
                        <img src="${review.ImageURL || 'default-image.jpg'}" alt="${review.Username}'s review">
                        <p class="rating">Rating: ${review.Rating}</p>
                    `;
                reviewsDiv.appendChild(reviewCard);
            });

            // Add "Add Review" Button
            const addReviewButton = document.createElement('button');
            addReviewButton.textContent = 'Add Review';
            addReviewButton.addEventListener('click', () => openReviewModal(recipeId));
            reviewsDiv.appendChild(addReviewButton);

            recipeCard.appendChild(reviewsDiv);
        };

        // Open review modal
        const openReviewModal = (recipeId) => {
            reviewModal.style.display = 'block';
            reviewForm.onsubmit = (e) => {
                e.preventDefault();
                handleAddReview(recipeId);
            };
        };

        // Handle adding a review
        const handleAddReview = async (recipeId) => {
            const description = reviewDescriptionInput.value;
            const rating = parseFloat(reviewRatingInput.value);
            const imageURL = reviewImageInput.value;

            const response = await fetch('https://0oo843p1e5.execute-api.us-east-1.amazonaws.com/prod/addReview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    body: JSON.stringify({
                        RecipeId: recipeId,
                        ReviewerUserId: user.UserId,
                        Rating: rating,
                        Description: description,
                        ImageURL: imageURL,
                    }),
                }),
            });

            if (response.ok) {
                alert('Review added successfully!');
                reviewModal.style.display = 'none';
                fetchRecipes(); // Refresh the recipe list to reflect the new review
            } else {
                alert('Error adding review');
            }
        };

        // Close review modal
        const closeReviewModal = () => {
            reviewModal.style.display = 'none';
        };

        // Initialize page
        const init = async () => {
            await fetchUser();
            await fetchRecipes();
            sortSelect.addEventListener('change', () => handleSort(allRecipes, sortSelect.value));
            searchInput.addEventListener('input', handleSearch);
        };

        init();
    </script>

</body>
</html>

